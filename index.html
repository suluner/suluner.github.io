<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.4.2',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'Copy',
      copy_success: 'Copied',
      copy_failure: 'Copy failed'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="keywords" content="技术，生活">
<meta property="og:type" content="website">
<meta property="og:title" content="月落阁">
<meta property="og:url" content="https:&#x2F;&#x2F;suluner.github.io&#x2F;index.html">
<meta property="og:site_name" content="月落阁">
<meta property="og:locale" content="zh-cn">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://suluner.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>

  <title>月落阁</title>
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">月落阁</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">非典型程序猿</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="https://suluner.github.io/2020/12/22/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83%E4%BC%98%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="胡挺">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="月落阁">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/22/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83%E4%BC%98%E5%8C%96/" class="post-title-link" itemprop="url">深度学习模型训练优化</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-12-22 10:08:58 / Modified: 10:10:43" itemprop="dateCreated datePublished" datetime="2020-12-22T10:08:58+08:00">2020-12-22</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><ul>
<li>训练性能</li>
<li>资源占用</li>
<li>模型效果</li>
</ul>
<h2 id="baseline"><a href="#baseline" class="headerlink" title="baseline"></a>baseline</h2><h3 id="训练性能"><a href="#训练性能" class="headerlink" title="训练性能"></a>训练性能</h3><ul>
<li>IO：缓存，pipeline，并行处理，数据存储方式（稀疏化存储）</li>
<li>计算：超参调整（batch-size），优化器选择，梯度更新方式，稀疏表示运算，线程数量调整（线程太多，切换代价高）</li>
</ul>
<h3 id="资源占用"><a href="#资源占用" class="headerlink" title="资源占用"></a>资源占用</h3><ul>
<li><p>流式读取训练数据</p>
</li>
<li><p>buffer size</p>
</li>
<li><p>优化器</p>
</li>
<li><p>模型编写方式</p>
</li>
</ul>
<h3 id="模型效果"><a href="#模型效果" class="headerlink" title="模型效果"></a>模型效果</h3><ul>
<li>模型结构</li>
<li>优化器</li>
<li>超参</li>
</ul>
<h2 id="分布式"><a href="#分布式" class="headerlink" title="分布式"></a>分布式</h2><p>阿姆达尔定律评估加速上限，提供理论指导。</p>
<p>尽量提高计算访存比。</p>
<h3 id="训练性能-1"><a href="#训练性能-1" class="headerlink" title="训练性能"></a>训练性能</h3><ul>
<li><p>分布式模式选择：AllReduce vs PS</p>
</li>
<li><p>数据切分方式：文件名切分</p>
</li>
<li><p>梯度合并方式：提高计算/通信比。提高并发，降低延迟</p>
</li>
<li><p>PS模式下，大tensor切分</p>
</li>
<li><p>Horovod模式下，梯度融合传递</p>
</li>
<li><p>调度策略（bin-pack, spread）</p>
</li>
</ul>
<h3 id="模型效果-1"><a href="#模型效果-1" class="headerlink" title="模型效果"></a>模型效果</h3><ul>
<li>超参调整：lr</li>
</ul>
<h2 id="高级话题"><a href="#高级话题" class="headerlink" title="高级话题"></a>高级话题</h2><ul>
<li>特征动态增删（Dynamic embedding）</li>
<li>实时训练</li>
<li>可伸缩分布式训练（elasticDL，FTlib）</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="https://suluner.github.io/2020/12/22/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E4%BC%98%E5%8C%96%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="胡挺">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="月落阁">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/22/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E4%BC%98%E5%8C%96%E5%99%A8/" class="post-title-link" itemprop="url">深度学习优化器</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-12-22 10:05:28 / Modified: 10:08:06" itemprop="dateCreated datePublished" datetime="2020-12-22T10:05:28+08:00">2020-12-22</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="梯度下降思想"><a href="#梯度下降思想" class="headerlink" title="梯度下降思想"></a>梯度下降思想</h2><p>Gradient Descent 的核心思想非常的简单。针对一个模型，我们最终希望它的（非负的）损失函数最小：<code>𝜽 = argmin J(𝜽)</code>。</p>
<p>根据 <a href="https://en.wikipedia.org/wiki/Gradient_descent" target="_blank" rel="noopener">Gradient Descent on Wikipedia</a>，GD 秉持一个最朴素的思想：<code>J&#39;(𝜽)</code> 指向哪里，沿着它的反方向 <code>-J&#39;(𝜽)</code> 走（即 <code>𝜽_next = 𝜽_now - J&#39;(𝜽)</code>），就能让 <code>J(𝜽)</code> 降低。</p>
<p>梯度下降公式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">𝜽_next = 𝜽_now - 𝜺*J&apos;(𝜽)</span><br><span class="line"></span><br><span class="line">𝜺为学习率。</span><br></pre></td></tr></table></figure>

<h2 id="BGD"><a href="#BGD" class="headerlink" title="BGD"></a>BGD</h2><p>每次计算整个训练集损失函数的均值，然后求导进行更新。</p>
<p>由于这种方法是在一次更新中，就对整个数据集计算梯度。</p>
<p>存在两个问题：</p>
<ul>
<li>计算速度慢</li>
<li>计算占用内存大</li>
</ul>
<p>所以几乎无法投入实际使用</p>
<h2 id="SGD"><a href="#SGD" class="headerlink" title="SGD"></a>SGD</h2><p>每次对单个样本计算损失函数和梯度，然后进行更新。</p>
<p>存在问题：</p>
<ul>
<li>存在较大的噪声，损失函数存在较大的震荡。</li>
</ul>
<p>BGD可能收敛到局部最优点，SGD震荡可以跳出局部最优点，到达更好的最优点。</p>
<h2 id="Mini-batch-SGD"><a href="#Mini-batch-SGD" class="headerlink" title="Mini-batch SGD"></a>Mini-batch SGD</h2><p>结合BGD和SGD的特点，每次利用训练集的一部分样本更新模型。</p>
<p>存在问题：</p>
<p>但是每次使用小部分数据更新模型，这小部分数据的梯度与整体数据的梯度可能存在偏差，还是会存在震荡。</p>
<h2 id="Momentum"><a href="#Momentum" class="headerlink" title="Momentum"></a>Momentum</h2><p>单批样本更新存在偏差，那么就不要全速更新，一定程度上保留之前的梯度。颇有引入惯性定理的味道。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">v_t+1 = 𝝁v_t - 𝜺J&apos;(𝜽_t)</span><br><span class="line">𝜽_t+1 = 𝜽_t + v_t+1</span><br><span class="line"></span><br><span class="line">𝜺 是学习率，𝝁 则为一个取值 [0,1] 的动量系数。</span><br></pre></td></tr></table></figure>

<h2 id="Nesterov-Momentum"><a href="#Nesterov-Momentum" class="headerlink" title="Nesterov Momentum"></a>Nesterov Momentum</h2><p>Momentum算法的改进版</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">v_t+1 = 𝝁v_t - 𝜺J&apos;(𝜽_t + 𝝁v_t)</span><br><span class="line">𝜽_t+1 = 𝜽_t + v_t+1</span><br></pre></td></tr></table></figure>

<p>区别在于，将梯度计算放在施加当前速度之后。相当于计算梯度时，按照全局趋势先走半步，进一步减小偏差。</p>
<p>以上算法在各个维度上的下降速度是一致的。然而在实际情况中，损失函数对不同的维度的敏感度是不一样的，因此对不同维度设置不同的学习率是一种比较好的方式。以下自适应学习率的方法即是这种思想的体现。</p>
<h2 id="Delta-bar-delta"><a href="#Delta-bar-delta" class="headerlink" title="Delta-bar-delta"></a>Delta-bar-delta</h2><p>基于一种简单的思想：</p>
<ol>
<li>如果过去两次更新的梯度符号相同，代表方向正确，增大更新时的步长</li>
<li>如果过去两次更新的梯度符号相反，代表方向不定，缩小更新时的步长</li>
</ol>
<p>这种方法只能用在全批量优化中，在 Mini-Batch 上却不好。每个 Mini-Batch 之间的差别会使得每一次更新本身的步长就会有很大的差异，这一点和全量数据更新时有比较明显的差异。</p>
<h2 id="Adagrad"><a href="#Adagrad" class="headerlink" title="Adagrad"></a>Adagrad</h2><p>累计所有参数的历史梯度平方和，参数学习率与梯度平方和2次方根成反比。达到的效果是：</p>
<ul>
<li><p>在陡坡，学习率变小</p>
</li>
<li><p>在平地，学习率变大</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">r = r + g^2</span><br><span class="line"></span><br><span class="line">𝜽_t+1 = 𝜽_t - e/(o + r)^0.5 * g</span><br></pre></td></tr></table></figure>

<p>存在问题：</p>
<ul>
<li>学习率过度减小</li>
</ul>
<p>适合凸函数优化</p>
<ul>
<li>优化器需要要对每个参数保存一个中间值，占用内存参数的两倍。</li>
</ul>
<h2 id="RMSProp"><a href="#RMSProp" class="headerlink" title="RMSProp"></a>RMSProp</h2><p>Hinton改进Adagrad算法适用于非凸优化场景。</p>
<p>加入指数衰减，丢弃遥远过去的历史：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">r = p*r + (1-p)g^2</span><br><span class="line"></span><br><span class="line">𝜽_t+1 = 𝜽_t - e/(o + r)^0.5 * g</span><br></pre></td></tr></table></figure>

<p>这种算法被证明是深度学习模型中非常有效的一种方法。</p>
<ul>
<li>优化器需要要对每个参数保存一个中间值，占用内存参数的两倍。</li>
</ul>
<h2 id="Adadelta"><a href="#Adadelta" class="headerlink" title="Adadelta"></a>Adadelta</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">r = p*r + (1-p)g^2</span><br><span class="line"></span><br><span class="line">对梯度下降的速度也做一个估计，用来当作学习率</span><br><span class="line">e = p*e + (1-p)𝜽^2</span><br><span class="line"></span><br><span class="line">𝜽_t+1 = 𝜽_t - e^0.5/(o + r)^0.5 * g</span><br></pre></td></tr></table></figure>

<p>不用设定学习率。</p>
<ul>
<li>优化器需要要对每个参数保存2个中间值，占用内存参数的三倍。</li>
</ul>
<h2 id="Adam"><a href="#Adam" class="headerlink" title="Adam"></a>Adam</h2><p>集合RMSProp和动量算法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">m_t = 𝜷_1*m_t-1 + (1 - 𝜷_1)*J&apos;(𝜽)</span><br><span class="line"></span><br><span class="line">v_t = 𝜷_2*v_t-1 + (1 - 𝜷_2)*J&apos;(𝜽)^2</span><br><span class="line"></span><br><span class="line">对期望和方差做修正：</span><br><span class="line">m_hat_t = m_t / (1 - 𝜷_1^t)</span><br><span class="line">v_hat_t = v_t / (1 - 𝜷_2^t)</span><br><span class="line"></span><br><span class="line">𝜽_w,t = 𝜽_w,t-1 - 𝜂*m_hat_t/(sqrt(v_hat_t) + 𝜺)</span><br><span class="line"></span><br><span class="line">𝜺 是一个用以保证数值稳定的一个很小的值。</span><br></pre></td></tr></table></figure>

<ul>
<li>优化器需要要对每个参数保存2个中间值，占用内存参数的三倍。</li>
</ul>
<h2 id="优化器效果对比"><a href="#优化器效果对比" class="headerlink" title="优化器效果对比"></a>优化器效果对比</h2><p><strong>如果数据是稀疏的，就用自适用方法，即 Adagrad, Adadelta, RMSprop, Adam。</strong></p>
<p><strong>RMSprop, Adadelta, Adam 在很多情况下的效果是相似的。</strong></p>
<p><strong>Adam 就是在 RMSprop 的基础上加了 bias-correction 和 momentum，</strong></p>
<p><strong>随着梯度变的稀疏，Adam 比 RMSprop 效果会好。</strong></p>
<p>整体来讲，<strong>Adam 是最好的选择</strong>。</p>
<p>很多论文里都会用 SGD，没有 momentum 等。<strong>SGD 虽然能达到极小值，但是比其它算法用的时间长，而且可能会被困在鞍点</strong>。</p>
<p>如果需要更快的收敛，或者是训练更深更复杂的神经网络，需要用一种自适应的算法。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="https://suluner.github.io/2020/02/06/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E9%9D%A2%E8%AF%95%E8%A3%85%E9%80%BC%E6%8C%87%E5%8D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="胡挺">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="月落阁">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/06/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E9%9D%A2%E8%AF%95%E8%A3%85%E9%80%BC%E6%8C%87%E5%8D%97/" class="post-title-link" itemprop="url">深度学习面试装逼指南</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-02-06 17:51:01 / Modified: 17:54:32" itemprop="dateCreated datePublished" datetime="2020-02-06T17:51:01+08:00">2020-02-06</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="原文"><a href="#原文" class="headerlink" title="原文"></a>原文</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">举一个我面试中遇到过的目前最牛的例子，简称M。我一般负责和人吃饭闲聊。这位先生以前在Intel，只大概看过机器学习的一些东西。</span><br><span class="line">我：目前深度学习当中用mapreduce的比较少，因为我们经常要SGD，</span><br><span class="line">M：哦我猜一下，所以你们用MPI，然后你要优化Allreduce。</span><br><span class="line">我：。。。对的，然后很多时候网络会有瓶颈，</span><br><span class="line">M：恩，因为你们不想上infiniband。我：。。。对的，</span><br><span class="line">M：然后你们 网络的 吞吐速度是够的，但是延迟不理想。</span><br><span class="line">我：。。。对的，</span><br><span class="line">M：所以你们想要有异步通信，但是同时又要控制 模型不发散。</span><br><span class="line">我：。。。对的。</span><br><span class="line">我：然后我们的模型在部署的时候希望尽量高速，一个方法是 找稀疏解，</span><br><span class="line">M：但是你们发现稀疏性不够，目前的运行库需要1-5%的稀疏性才行。</span><br><span class="line">我：。。。对的，</span><br><span class="line">M：但是你们估计最多只有30%上下的稀疏性，否则模型质量就下降。</span><br><span class="line">我：对的。但是还是有一些办法，因为部署的时候模型是固定的，</span><br><span class="line">M：所以可以做即时编译然后内联参数。</span><br><span class="line">我：。。。对的。</span><br><span class="line"></span><br><span class="line">所以面试的加分项就是面试官还没问问题，你就先回答完了。装b结束了，说说我大概想表达的意思吧：机器学习里面了解怎么推公式，怎么解释算法等等，都是停留在技术的层面上。技术牛肯定是有加分的，但是如果要找一位算法/系统架构师，更容易加分的是了解这些技术背后真正解决的问题，在出现 需求的时候能很快解释背后的原理，然后找到解决问题的思路。这也是为啥我在面试的时候不问具体技术细节的缘故 - 开个玩笑，好的架构师只需要写头文件就行。。。</span><br><span class="line"></span><br><span class="line">=== 因为评论说没看懂，具体展开说 ===</span><br><span class="line"></span><br><span class="line">SGD+MPI+Allreduce：这个问的是机器学习当中SGD算法怎样并行化，以及如何处理并行当中的计算模式，讨论可以见Allreduce (or MPI) vs. Parameter server approaches（https://hunch.net/?p=151364）</span><br><span class="line"></span><br><span class="line">网络瓶颈：需要正确估计计算时间和网络通讯之间的比例，保证可以实现pipeline：Pipeline (computing)</span><br><span class="line"></span><br><span class="line">Infiniband以及ethernet：问的是大规模系统架构的时候的硬件选择问题，不想上Infiniband是因为成本问题，以及容易被少数vendor lock in的风险。</span><br><span class="line"></span><br><span class="line">网络的吞吐和延迟的区别：What is the difference between latency and throughput?</span><br><span class="line"></span><br><span class="line">异步通信的时候对于收敛性的影响：可以参见google的async sgd，sync sgd revisited，Eric Xing的latency bounded sgd，以及EASGD等一系列文章的讨论。</span><br><span class="line"></span><br><span class="line">模型的稀疏解：这个涉及到对于模型稀疏化能力的正确估计，目前的很多网络要保证不丢准确率的情况下，很难做到传统稀疏矩阵的那种要求。</span><br><span class="line"></span><br><span class="line">稀疏矩阵库的计算效率问题：这个如果做过数值优化的话应该是常识，但是五秒钟里面能从上一条跳到这一条然后找到瓶颈还是让我很惊讶的。</span><br><span class="line"></span><br><span class="line">即时编译和内联参数：这个比较涉及到数值优化的一系列可能性，以及对于编译器的期望，本身就是一道可以展开说一个钟头的问题。。。比如说，我们在做矩阵乘法的时候是需要pre-pack矩阵的，如果我们知道参数矩阵不会变，我们就可以预先pack，然后如果你可以自己写编译器来利用这些特性的话，你甚至可以没有那个矩阵，直接出一个程序把参数都写在指令里头。一般面试是不会涉及到那么多问题的，其中一两个就够讨论了，M先生属于特别牛的那种。。。</span><br></pre></td></tr></table></figure>

<h2 id="知识点解读"><a href="#知识点解读" class="headerlink" title="知识点解读"></a>知识点解读</h2><h3 id="深度学习并行计算模式"><a href="#深度学习并行计算模式" class="headerlink" title="深度学习并行计算模式"></a>深度学习并行计算模式</h3><p>MPI vs PS</p>
<p>single-machine vs. multi-machine</p>
<p>deterministic vs. nondeterministic</p>
<h3 id="网络瓶颈"><a href="#网络瓶颈" class="headerlink" title="网络瓶颈"></a>网络瓶颈</h3><p>计算通信比决定是否要pipeline。当计算通信比接近1:1时，pipeline的效果是比较明显的。</p>
<h3 id="网络硬件选择"><a href="#网络硬件选择" class="headerlink" title="网络硬件选择"></a>网络硬件选择</h3><p>Infiniband vs ethernet，Infiniband成本比较高，且有vendor locked in的风险。</p>
<h3 id="网络带宽和延迟"><a href="#网络带宽和延迟" class="headerlink" title="网络带宽和延迟"></a>网络带宽和延迟</h3><p>带宽足够，但是延迟高。那么可以加大并行通信的数量来进行优化。比如采用异步通信，充分利用带宽，提高单位时间数据传输量。</p>
<h3 id="异步通信对模型收敛的影响"><a href="#异步通信对模型收敛的影响" class="headerlink" title="异步通信对模型收敛的影响"></a>异步通信对模型收敛的影响</h3><p>一般来说，异步通信会使得模型收敛性变差。</p>
<h3 id="模型稀疏解"><a href="#模型稀疏解" class="headerlink" title="模型稀疏解"></a>模型稀疏解</h3><p>模型稀疏的好处：</p>
<ul>
<li><p>特征自动选择</p>
</li>
<li><p>可解释性</p>
</li>
<li><p>稀疏模型可采用算法压缩，容易存储和传输，加快模型部署</p>
</li>
</ul>
<h3 id="稀疏矩阵库计算效率"><a href="#稀疏矩阵库计算效率" class="headerlink" title="稀疏矩阵库计算效率"></a>稀疏矩阵库计算效率</h3><p>矩阵越稀疏，稀疏矩阵库的计算速度越快</p>
<h3 id="即时编译和参数内联"><a href="#即时编译和参数内联" class="headerlink" title="即时编译和参数内联"></a>即时编译和参数内联</h3><p>矩阵稀疏度不够，利用模型不变的特性，可以从编译方面对速度进行优化</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="https://suluner.github.io/2019/12/20/GTC%E4%BC%9A%E8%AE%AE%E7%BA%AA%E8%A6%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="胡挺">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="月落阁">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/20/GTC%E4%BC%9A%E8%AE%AE%E7%BA%AA%E8%A6%81/" class="post-title-link" itemprop="url">GTC会议纪要</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2019-12-20 15:10:18 / Modified: 15:12:04" itemprop="dateCreated datePublished" datetime="2019-12-20T15:10:18+08:00">2019-12-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BC%9A%E8%AE%AE/" itemprop="url" rel="index">
                    <span itemprop="name">会议</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="黄教主演讲"><a href="#黄教主演讲" class="headerlink" title="黄教主演讲"></a>黄教主演讲</h2><ul>
<li>GPU在各个行业中的应用：游戏，电影，模拟软件，HPC(基因测序)，AI…</li>
<li>Cuda on Arm，加速高性能计算</li>
<li>AI 复兴： alexnet图像领域， bert NLP领域</li>
<li>AI引擎-GPU</li>
<li>深度推荐系统-互联网的引擎<ul>
<li>百度</li>
<li>阿里</li>
</ul>
</li>
<li>TensorRT 5<ul>
<li>CNN</li>
<li>30多种变换</li>
<li>自动混合精度</li>
</ul>
</li>
<li>TensorRT 7<ul>
<li>CNN and RNN，Transformer</li>
<li>1000多种变换</li>
<li>低延迟，会话AI成为可能</li>
</ul>
</li>
<li>为智能云提供支持</li>
<li>万物智能革命，边缘计算</li>
<li>边缘智能，AI靠近作用点</li>
<li>机器人平台，4种SDK<ul>
<li>自动驾驶<ul>
<li>迁移学习</li>
<li>联邦学习，共享模型，不共享数据</li>
</ul>
</li>
<li>医疗</li>
<li>非结构化环境导航和关节控制</li>
<li>通用机器人</li>
</ul>
</li>
</ul>
<h2 id="GPU虚拟化"><a href="#GPU虚拟化" class="headerlink" title="GPU虚拟化"></a>GPU虚拟化</h2><ul>
<li>vGPU10.0发布</li>
<li>vGPU性能比GPU损耗10%左右</li>
<li>GPU虚拟化的价值：适配多种场景需求</li>
<li>GPU虚拟化下的产品形态<ul>
<li>IaaS产品：云桌面，云电脑</li>
<li>行业产品：云游戏</li>
</ul>
</li>
<li>云上的实践：弹性容器服务</li>
<li>vGPU价值：安全性，故障监测，热迁移，粒度更细，池化</li>
<li>vGPU在云上可以做到算力细化和算力多样化，算力匹配可以降低客户成本。灵活性，可用性，安全性</li>
</ul>
<h2 id="美团案例分享"><a href="#美团案例分享" class="headerlink" title="美团案例分享"></a>美团案例分享</h2><ul>
<li>TF-serving应用</li>
</ul>
<h2 id="腾讯如何构建AI-强化学习平台"><a href="#腾讯如何构建AI-强化学习平台" class="headerlink" title="腾讯如何构建AI+强化学习平台"></a>腾讯如何构建AI+强化学习平台</h2><ul>
<li>算力挖掘：CPU， GPU虚拟化: 人-&gt;物理机-》人-&gt;卡-》任务-&gt;卡</li>
<li>并行强化框架</li>
<li>训练加速<ul>
<li>通信优化：NCCL2+ RDMA，梯度融合（多次梯度传输合并为一次），混合层次算法</li>
<li>IO优化：IO隐藏，多线程+无锁队列+共享内存</li>
<li>fp16数据输入</li>
</ul>
</li>
<li>GPU推理加速<ul>
<li>性能<ul>
<li>使用GPU TensorRT</li>
<li>Refit</li>
<li>tensorflow model -&gt; tensorrt model</li>
</ul>
</li>
<li>流量<ul>
<li>GPU推理和训练机器在同一IDC机房</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="飞浆并行训练与应用"><a href="#飞浆并行训练与应用" class="headerlink" title="飞浆并行训练与应用"></a>飞浆并行训练与应用</h2><ul>
<li>同步算法，任务特点：通信密集，延迟敏感，显存瓶颈</li>
<li>基础组件：Collective Operators</li>
<li>MPI原语封装为高级api，提高易用性。Fleet API</li>
<li>低配网络环境下的GPU并行<ul>
<li>变频通信。降低通信次数，每块卡训练多步通信一次。</li>
<li>稀疏通信，梯度稀疏化</li>
</ul>
</li>
<li>有限显存下提升batch的方式<ul>
<li>显存回收，删除中间变量，需要用到时重新计算（重新计算时与通信进行overlap，减少计算时间）。时间换空间</li>
</ul>
</li>
<li>基于模型并行的超大规模分类<ul>
<li>item过多，最后一层全连接层太大，内存装不下——模型并行：分治策略+模型并行训练。</li>
</ul>
</li>
</ul>
<h2 id="阿里云飞天AI加速解决方案"><a href="#阿里云飞天AI加速解决方案" class="headerlink" title="阿里云飞天AI加速解决方案"></a>阿里云飞天AI加速解决方案</h2><ul>
<li>AI三大要素：数据，算法，算力</li>
<li>飞天AI加速器（一个库？），统一加速各种训练框架。加速器有个接入层，接入到各个框架。IaaS层面优化，计算，通信，存储等。</li>
<li>即刻构建——AI工作流：省时，省钱，易用</li>
<li>K8s容器AI解决方案</li>
<li>分布式训练加速性能优化<ul>
<li>通信计算重叠 异步通信梯度</li>
<li>延迟优化 去中心化方式聚合梯度</li>
<li>带宽优化 拓扑结构分级通信，混合精度传输梯度，多梯度融合通信，动态分片通信，融合粒度分片通信动态调整</li>
</ul>
</li>
</ul>
<h2 id="GPU云计算平台给AI实现真正普惠"><a href="#GPU云计算平台给AI实现真正普惠" class="headerlink" title="GPU云计算平台给AI实现真正普惠"></a>GPU云计算平台给AI实现真正普惠</h2><ul>
<li>AI产业价值：物流，城市，金融。。。</li>
<li>AI开放平台</li>
<li>京东云解决方案</li>
<li>技术能力对外输出：AI，区块链，大数据，物联网，安全，云计算</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="https://suluner.github.io/2019/12/05/Python%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E5%BA%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="胡挺">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="月落阁">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/05/Python%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E5%BA%93/" class="post-title-link" itemprop="url">Python开发常用库</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2019-12-05 14:33:55 / Modified: 19:27:55" itemprop="dateCreated datePublished" datetime="2019-12-05T14:33:55+08:00">2019-12-05</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Language/" itemprop="url" rel="index">
                    <span itemprop="name">Language</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="参数解析——argparse"><a href="#参数解析——argparse" class="headerlink" title="参数解析——argparse"></a>参数解析——argparse</h2><p>python解析命令行参数时，可以使用sys.argv，optparse，argparse模块。</p>
<p>其中argparse模块功能最丰富友好，是optparse库的升级版，推荐使用。optparse自从3.2和2.7版本已经不再开发。</p>
<p>getopt模块是为了照顾习惯C语言里面的getopt库而开发的，如果用户不熟悉C语言中的getopt，没有必要使用。</p>
<h2 id="日志——logging"><a href="#日志——logging" class="headerlink" title="日志——logging"></a>日志——logging</h2><p>非常全面灵活的日志库。</p>
<h2 id="高级文件和目录操作——shutil"><a href="#高级文件和目录操作——shutil" class="headerlink" title="高级文件和目录操作——shutil"></a>高级文件和目录操作——shutil</h2><p>shutil库主要对复制文件，删除文件，压缩文件具有良好的支持。对单个文件进行操作可以使用os库。</p>
<p>压缩文件功能依赖zipfile和tarfile库。</p>
<p>os包含与操作系统有关的接口，参考os库介绍：</p>
<p>本模块提供了一种使用与操作系统相关的功能的便捷式途径。 如果你只是想读写一个文件，请参阅 <a href="https://docs.python.org/zh-cn/3/library/functions.html#open" target="_blank" rel="noopener"><code>open()</code></a>，如果你想操作文件路径，请参阅 <a href="https://docs.python.org/zh-cn/3/library/os.path.html#module-os.path" target="_blank" rel="noopener"><code>os.path</code></a> 模块，如果你想读取通过命令行给出的所有文件中的所有行，请参阅 <a href="https://docs.python.org/zh-cn/3/library/fileinput.html#module-fileinput" target="_blank" rel="noopener"><code>fileinput</code></a> 模块。 为了创建临时文件和目录，请参阅 <a href="https://docs.python.org/zh-cn/3/library/tempfile.html#module-tempfile" target="_blank" rel="noopener"><code>tempfile</code></a> 模块，对于高级文件和目录处理，请参阅 <a href="https://docs.python.org/zh-cn/3/library/shutil.html#module-shutil" target="_blank" rel="noopener"><code>shutil</code></a> 模块。</p>
<h2 id="HTTP库——Requests"><a href="#HTTP库——Requests" class="headerlink" title="HTTP库——Requests"></a>HTTP库——Requests</h2><p>Urllib3是Requests库实现的基石</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="https://suluner.github.io/2019/11/24/%E4%B8%8D%E5%90%8C%E5%B1%82%E6%AC%A1%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="胡挺">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="月落阁">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/24/%E4%B8%8D%E5%90%8C%E5%B1%82%E6%AC%A1%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/" class="post-title-link" itemprop="url">不同层次的负载均衡</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2019-11-24 15:12:34 / Modified: 15:35:00" itemprop="dateCreated datePublished" datetime="2019-11-24T15:12:34+08:00">2019-11-24</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BD%91%E7%BB%9C/" itemprop="url" rel="index">
                    <span itemprop="name">网络</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="负载均衡的层次"><a href="#负载均衡的层次" class="headerlink" title="负载均衡的层次"></a>负载均衡的层次</h2><p><strong>二层负载均衡(mac)</strong><br> 一般是用<code>虚拟mac地址</code>方式,外部对虚拟MAC地址请求,负载均衡接收后分配后端实际的MAC地址响应。</p>
<p> <strong>三层负载均衡(ip)</strong><br> 一般采用<code>虚拟IP地址</code>方式,外部对虚拟的ip地址请求,负载均衡接收后分配后端实际的IP地址响应。</p>
<p> <strong>四层负载均衡(tcp)</strong><br> 用<code>虚拟ip+port</code>接收请求,再转发到对应的真实机器。</p>
<p> <strong>七层负载均衡(http)</strong><br> 用<code>虚拟的url或主机名</code>接收请求,再转向相应的处理服务器。</p>
<p>通常使用的是四层和七层负载均衡，下面详细说明这两种负载均衡。</p>
<h2 id="四层和七层负载均衡的区别"><a href="#四层和七层负载均衡的区别" class="headerlink" title="四层和七层负载均衡的区别"></a>四层和七层负载均衡的区别</h2><p>所谓的四层或七层负载均衡，就是在对后台的服务器进行负载均衡时，<strong>依据四层的信息或七层的信息来决定怎么样转发流量</strong>。 比如四层的负载均衡，就是通过发布三层的IP地址（VIP），然后加四层的端口号，来决定哪些流量需要做负载均衡，对需要处理的流量进行NAT处理，转发至后台服务器，并记录下这个TCP或者UDP的流量是由哪台服务器处理的，后续这个连接的所有流量都同样转发到同一台服务器处理。七层的负载均衡，就是在四层的基础上（没有四层是绝对不可能有七层的），再考虑应用层的特征，比如同一个Web服务器的负载均衡，除了根据VIP加80端口辨别是否需要处理的流量，还可根据七层的URL、浏览器类别、语言来决定是否要进行负载均衡。举个例子，如果你的Web服务器分成两组，一组是中文语言的，一组是英文语言的，那么七层负载均衡就可以当用户来访问你的域名时，自动辨别用户语言，然后选择对应的语言服务器组进行负载均衡处理。</p>
<h3 id="技术原理"><a href="#技术原理" class="headerlink" title="技术原理"></a>技术原理</h3><ul>
<li><p>所谓<strong>四层负载均衡</strong>，也就是主要通过报文中的目标地址和端口，再加上负载均衡设备设置的服务器选择方式，决定最终选择的内部服务器。</p>
<p>以常见的TCP为例，负载均衡设备在接收到第一个来自客户端的SYN 请求时，即通过上述方式选择一个最佳的服务器，并对报文中目标IP地址进行修改(改为后端服务器IP），直接转发给该服务器。TCP的连接建立，即<strong>三次握手是客户端和服务器直接建立的，负载均衡设备只是起到一个类似路由器的转发动作</strong>。在某些部署情况下，为保证服务器回包可以正确返回给负载均衡设备，在转发报文的同时可能还会对报文原来的源地址进行修改。</p>
</li>
<li><p>所谓<strong>七层负载均衡</strong>，也称为“内容交换”，也就是主要通过报文中的真正有意义的应用层内容，再加上负载均衡设备设置的服务器选择方式，决定最终选择的内部服务器。</p>
<p>以常见的TCP为例，负载均衡设备如果要根据真正的应用层内容再选择服务器，只能先代理最终的服务器和客户端建立连接(三次握手)后，才可能接受到客户端发送的真正应用层内容的报文，然后再根据该报文中的特定字段，再加上负载均衡设备设置的服务器选择方式，决定最终选择的内部服务器。<strong>负载均衡设备在这种情况下，更类似于一个代理服务器</strong>。负载均衡和前端的客户端以及后端的服务器会分别建立TCP连接。所以从这个技术原理上来看，七层负载均衡明显的对负载均衡设备的要求更高，处理七层的能力也必然会低于四层模式的部署方式。</p>
</li>
</ul>
<h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><p>七层因为可以代理任意修改和处理用户的请求，所以可以使整个应用更加智能化和安全，代价就是设计和配置会更复杂。所以是否有必要使用七层负载均衡是一个需要权衡的问题。</p>
<p>现在的7层负载均衡，主要还是着重于应用HTTP协议，所以其应用范围主要是众多的网站或者内部信息平台等基于B/S开发的系统。 4层负载均衡则对应其他TCP应用，例如基于C/S开发的ERP等系统。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="https://suluner.github.io/2019/11/22/python%E4%B8%AD%E7%9A%84%E8%B5%8B%E5%80%BC%EF%BC%8C%E6%B5%85%E6%8B%B7%E8%B4%9D%E4%B8%8E%E6%B7%B1%E6%8B%B7%E8%B4%9D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="胡挺">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="月落阁">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/22/python%E4%B8%AD%E7%9A%84%E8%B5%8B%E5%80%BC%EF%BC%8C%E6%B5%85%E6%8B%B7%E8%B4%9D%E4%B8%8E%E6%B7%B1%E6%8B%B7%E8%B4%9D/" class="post-title-link" itemprop="url">python中的赋值，浅拷贝与深拷贝</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2019-11-22 19:39:28 / Modified: 21:14:23" itemprop="dateCreated datePublished" datetime="2019-11-22T19:39:28+08:00">2019-11-22</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在写python项目的时候，遇见一个python拷贝对象的坑，在此总结记录一下python中的赋值，浅拷贝与深拷贝。</p>
<h2 id="不可变数据类型：数字，字符串和元组"><a href="#不可变数据类型：数字，字符串和元组" class="headerlink" title="不可变数据类型：数字，字符串和元组"></a>不可变数据类型：数字，字符串和元组</h2><p>在python中，不可变对象的赋值，浅拷贝，深拷贝都指向同一个地址，三者没有区别：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>n1 = <span class="number">1</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>n2 = n1</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>n3 = copy.copy(n1)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>n4 = copy.deepcopy(n1)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>n1 = <span class="number">2</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(n1)</span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(n2)</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(n3)</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(n4)</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(id(n1))</span><br><span class="line"><span class="number">4503975584</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(id(n2))</span><br><span class="line"><span class="number">4503975552</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(id(n3))</span><br><span class="line"><span class="number">4503975552</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(id(n4))</span><br><span class="line"><span class="number">4503975552</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s = (<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s1 = s</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s2 = copy.copy(s)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s3 = copy.deepcopy(s)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s = (<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(s)</span><br><span class="line">(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(s1)</span><br><span class="line">(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(s2)</span><br><span class="line">(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(s3)</span><br><span class="line">(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(id(s))</span><br><span class="line"><span class="number">4508458760</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(id(s1))</span><br><span class="line"><span class="number">4508464256</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(id(s2))</span><br><span class="line"><span class="number">4508464256</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(id(s3))</span><br><span class="line"><span class="number">4508464256</span></span><br></pre></td></tr></table></figure>

<p>对于不可变类型，当修改的时候会<strong>替换</strong>旧的对象，（进行新的内存分配）产生一个新的地址</p>
<h3 id="元组对象比较特殊"><a href="#元组对象比较特殊" class="headerlink" title="元组对象比较特殊"></a>元组对象比较特殊</h3><p>元组是不可变对象，但是元素可以是可变对象，还是可以改变元组的元素 。</p>
<p>当元组元素是不可变类型时，赋值，浅拷贝，深拷贝都指向同一个地址。</p>
<p>当元组元素是可变类型时，赋值和浅拷贝指向同一地址，深拷贝会另辟空间。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>sf = ([<span class="number">1</span>,<span class="number">2</span>],[<span class="number">3</span>,<span class="number">4</span>])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sf1 = sf</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> copy</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sf2 = copy.copy(sf)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sf3 = copy.deepcopy(sf)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(id(sf))</span><br><span class="line"><span class="number">4387941064</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(id(sf1))</span><br><span class="line"><span class="number">4387941064</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(id(sf2))</span><br><span class="line"><span class="number">4387941064</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(id(sf3))</span><br><span class="line"><span class="number">4387952776</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sf[<span class="number">1</span>].append(<span class="number">5</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(id(sf))</span><br><span class="line"><span class="number">4387941064</span></span><br><span class="line">===================================</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sd = (<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sd1 = sd</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sd2 = copy.copy(sd)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sd3 = copy.deepcopy(sd)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(id(sd))</span><br><span class="line"><span class="number">4387950856</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(id(sd1))</span><br><span class="line"><span class="number">4387950856</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(id(sd2))</span><br><span class="line"><span class="number">4387950856</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(id(sd3))</span><br><span class="line"><span class="number">4387950856</span></span><br></pre></td></tr></table></figure>



<h2 id="可变数据类型：列表，字典和集合"><a href="#可变数据类型：列表，字典和集合" class="headerlink" title="可变数据类型：列表，字典和集合"></a>可变数据类型：列表，字典和集合</h2><p>一图胜千言：</p>
<p><img src="/images/posts/python_copy/copy.png" alt=""></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> copy</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b = a</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c = copy.copy(a)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d = copy.deepcopy(a)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a.append(<span class="number">4</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a[<span class="number">3</span>].append(<span class="number">4</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(a)</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>], <span class="number">4</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(b)</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>], <span class="number">4</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(c)</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(d)</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a_dict = &#123;<span class="string">'1'</span>:<span class="number">1</span>,<span class="string">'2'</span>:<span class="number">2</span>,<span class="string">'3'</span>:&#123;<span class="string">'1'</span>:<span class="number">1</span>,<span class="string">'2'</span>:<span class="number">2</span>,<span class="string">'3'</span>:<span class="number">3</span>&#125;&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b_dict = a_dict</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c_dict = copy.copy(a_dict)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d_dict = copy.deepcopy(a_dict)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a_dict[<span class="string">'4'</span>] = <span class="number">4</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a_dict[<span class="string">'3'</span>][<span class="string">'4'</span>] = <span class="number">4</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(a_dict)</span><br><span class="line">&#123;<span class="string">'1'</span>: <span class="number">1</span>, <span class="string">'2'</span>: <span class="number">2</span>, <span class="string">'3'</span>: &#123;<span class="string">'1'</span>: <span class="number">1</span>, <span class="string">'2'</span>: <span class="number">2</span>, <span class="string">'3'</span>: <span class="number">3</span>, <span class="string">'4'</span>: <span class="number">4</span>&#125;, <span class="string">'4'</span>: <span class="number">4</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(b_dict)</span><br><span class="line">&#123;<span class="string">'1'</span>: <span class="number">1</span>, <span class="string">'2'</span>: <span class="number">2</span>, <span class="string">'3'</span>: &#123;<span class="string">'1'</span>: <span class="number">1</span>, <span class="string">'2'</span>: <span class="number">2</span>, <span class="string">'3'</span>: <span class="number">3</span>, <span class="string">'4'</span>: <span class="number">4</span>&#125;, <span class="string">'4'</span>: <span class="number">4</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(c_dict)</span><br><span class="line">&#123;<span class="string">'1'</span>: <span class="number">1</span>, <span class="string">'2'</span>: <span class="number">2</span>, <span class="string">'3'</span>: &#123;<span class="string">'1'</span>: <span class="number">1</span>, <span class="string">'2'</span>: <span class="number">2</span>, <span class="string">'3'</span>: <span class="number">3</span>, <span class="string">'4'</span>: <span class="number">4</span>&#125;&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(d_dict)</span><br><span class="line">&#123;<span class="string">'1'</span>: <span class="number">1</span>, <span class="string">'2'</span>: <span class="number">2</span>, <span class="string">'3'</span>: &#123;<span class="string">'1'</span>: <span class="number">1</span>, <span class="string">'2'</span>: <span class="number">2</span>, <span class="string">'3'</span>: <span class="number">3</span>&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>注意，集合的元素不能为可变类型，所以对于集合浅拷贝和深拷贝没有区别。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>对于可变类型对象，赋值只是增加了一个对象的引用，它们指向内存中的同一个对象；浅拷贝会开辟新内存将对象拷贝一份，但是不会拷贝子对象；深拷贝会开辟新内存将对象拷贝后，连带子对象也拷贝，与原对象完全独立。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="https://suluner.github.io/2019/11/15/%E8%AE%B8%E5%BC%8F%E4%BC%9F%E7%9A%84%E6%9E%B6%E6%9E%84%E8%AF%BE%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="胡挺">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="月落阁">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/15/%E8%AE%B8%E5%BC%8F%E4%BC%9F%E7%9A%84%E6%9E%B6%E6%9E%84%E8%AF%BE%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">许式伟的架构课笔记</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-15 20:18:10" itemprop="dateCreated datePublished" datetime="2019-11-15T20:18:10+08:00">2019-11-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-11-16 20:47:20" itemprop="dateModified" datetime="2019-11-16T20:47:20+08:00">2019-11-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index">
                    <span itemprop="name">学习</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="MVC模式"><a href="#MVC模式" class="headerlink" title="MVC模式"></a>MVC模式</h2><p>mvc模式如下图所示：</p>
<p><img src="/images/posts/arch/mvc.png" alt=""></p>
<p>Model 是数据，View 是数据的显示结果，同时也接受用户的交互动作，也就是事件。从这个意义来说，说 Model 是 Input 并不严谨，View 接受的用户交互，也是 Input 的一部分。</p>
<p>Controller 负责 Process（处理），它接受 “Model + 由 View 转发的事件” 作为 Input，处理的结果（Output）仍然是 Model，它更新了 Model 的数据。</p>
<p>Model数据更新之后，会产生一个事件datachanged发给view，view进行视图的更新。</p>
<p>当Controller监听data changed事件，然后更新view时，就变成了另一种模式：mvp。</p>
<p><img src="/images/posts/arch/mvp.png" alt=""></p>
<h3 id="理解Model层"><a href="#理解Model层" class="headerlink" title="理解Model层"></a>理解Model层</h3><p>model层应该自然体现业务逻辑，不仅包括数据，也包括接口。</p>
<p>单一职责原则：不要干多件事，也不要啥事不干。</p>
<p>Model层的核心价值是业务需求，是稳定点；datachanged事件是面对需求变化点的对策。</p>
<p>model层越厚越好，这是跨平台最容易的部分。</p>
<h3 id="理解View层"><a href="#理解View层" class="headerlink" title="理解View层"></a>理解View层</h3><p>View层的首要责任是界面呈现，可以自己调用GDI画，也可以用子View画。</p>
<p>其次，响应用户事件，应该委托出去给别人干。</p>
<p>View层局部更新太复杂时，一般会引入ViewModel层，它的数据组织接近于View。</p>
<h2 id="理解Controller层"><a href="#理解Controller层" class="headerlink" title="理解Controller层"></a>理解Controller层</h2><p>Model层和View都是一个整体，而Controller层不是。它由一个一个不相关的controller和它需要的辅助view组成。controller之间可以完全不知道对方的存在。</p>
<p>应用程序将MVC各个模块串起来，在程序开始的时候，把Model，Controller，View层创建好，建立彼此关联。</p>
<h2 id="工程师文化"><a href="#工程师文化" class="headerlink" title="工程师文化"></a>工程师文化</h2><ul>
<li>事务与工程：防止掉入事务陷阱，花更多时间在工程上才有利于职业发展。</li>
<li>彻底解决问题：清楚定义目标，以自动化方式把事务彻底解决掉。</li>
<li>系统化与批判：去除不必要的代码，保证所有的代码行都有必须存在的目的。</li>
</ul>
<p>持续更新。。。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="https://suluner.github.io/2019/11/15/%E4%B8%BB%E6%9C%BA%E8%A3%85%E6%9C%BA%E8%AE%B0%E5%BD%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="胡挺">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="月落阁">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/15/%E4%B8%BB%E6%9C%BA%E8%A3%85%E6%9C%BA%E8%AE%B0%E5%BD%95/" class="post-title-link" itemprop="url">主机装机记录</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2019-11-15 19:14:21 / Modified: 19:45:44" itemprop="dateCreated datePublished" datetime="2019-11-15T19:14:21+08:00">2019-11-15</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%85%B4%E8%B6%A3/" itemprop="url" rel="index">
                    <span itemprop="name">兴趣</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>趁着双十一，组装了一台日常使用的台式机。配件清单如下：</p>
<table>
<thead>
<tr>
<th>配件</th>
<th>价格</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>主板+CPU套装（技嘉Z390 AORUS PRO WIFI+ i5-9600KF）</td>
<td>2758</td>
<td></td>
</tr>
<tr>
<td>金士顿(Kingston) DDR4 2666 16GB 内存条</td>
<td>495</td>
<td></td>
</tr>
<tr>
<td>七彩虹（Colorful）iGame GeForce GTX 1660 Ti</td>
<td>1899</td>
<td></td>
</tr>
<tr>
<td>三星970 EVO Plus 500G固态硬盘</td>
<td>799</td>
<td></td>
</tr>
<tr>
<td>希捷(Seagate)2TB 256MB 7200RPM 机械硬盘</td>
<td>369</td>
<td></td>
</tr>
<tr>
<td>安钛克(Antec)HCG750金牌全模组电源</td>
<td>799</td>
<td></td>
</tr>
<tr>
<td>九州风神（DEEPCOOL） 玄冰400 CPU散热器</td>
<td>89</td>
<td></td>
</tr>
<tr>
<td>爱国者（aigo）炫影黑京东专供版 电脑机箱</td>
<td>199</td>
<td></td>
</tr>
<tr>
<td>AOC I2490PXH5 23.8英寸显示屏</td>
<td>799</td>
<td></td>
</tr>
<tr>
<td>总计</td>
<td>8206</td>
<td></td>
</tr>
</tbody></table>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="https://suluner.github.io/2019/11/02/Iptables%E5%8E%9F%E7%90%86%E5%92%8C%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="胡挺">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="月落阁">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/02/Iptables%E5%8E%9F%E7%90%86%E5%92%8C%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">Iptables原理和使用</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-02 11:13:37" itemprop="dateCreated datePublished" datetime="2019-11-02T11:13:37+08:00">2019-11-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-11-15 20:21:04" itemprop="dateModified" datetime="2019-11-15T20:21:04+08:00">2019-11-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/OS/" itemprop="url" rel="index">
                    <span itemprop="name">OS</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><p>netfilter是一个免费的包过滤防火墙，位于内核空间，替代商业防火墙方案，完成封包过滤，封包重定向，网络地址转换（NAT）等功能。</p>
<p>iptables是一个命令行工具，位于用户空间，用来操作netfilter。</p>
<ul>
<li>5条链（关卡）：</li>
</ul>
<p><img src="/images/posts/iptable/link.png" alt=""></p>
<p>到本机某进程的报文：prerouting–&gt;input</p>
<p>本机某进程发出的报文：output–&gt;postrouting</p>
<p>本机转发的报文：prerouting–&gt;forward–&gt;postrouting</p>
<ul>
<li>4张表：</li>
</ul>
<p><img src="/images/posts/iptable/table.png" alt=""></p>
<p>表中包含一条条规则</p>
<p>规则组成：</p>
<p>匹配条件+处理动作</p>
<p>匹配条件：source ip,port destination ip, port</p>
<p>处理动作：accept, drop, reject, snat, masquerde, dnat, redirect, log</p>
<p>表的作用：</p>
<p>filter：过滤</p>
<p>nat：网络地址转换</p>
<p>mangle：拆解报文，作出修改，重新封包</p>
<p>raw：关闭nat表启用的连接追踪机制</p>
<h2 id="规则查看"><a href="#规则查看" class="headerlink" title="规则查看"></a>规则查看</h2><p>iptables -t 表名 -L 链名</p>
<p>选项：</p>
<p>-v 显示详细信息</p>
<p>-n 不解析IP地址</p>
<p>-x 显示计数器精确值</p>
<p>–line-number 规则显示编号</p>
<h2 id="规则管理"><a href="#规则管理" class="headerlink" title="规则管理"></a>规则管理</h2><ul>
<li>添加规则：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -t filter -I INPUT -s ip -j ACCEPT</span><br><span class="line"></span><br><span class="line">iptables -t filter -A INPIT -s ip -j ACCEPT</span><br></pre></td></tr></table></figure>

<p>-I  在表头插入规则</p>
<p>-A 在表尾追加规则</p>
<p>规则的顺序很重要，如果某个报文已经被前面的规则匹配了，那么后面的规则不会处理。</p>
<ul>
<li>删除规则</li>
</ul>
<p>按序号删除</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables --line -vnL INPUT</span><br><span class="line"></span><br><span class="line">iptables -t filter -D INPUT 3</span><br></pre></td></tr></table></figure>

<p>按匹配条件和处理动作删除</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t filter -D INPUT -s ip -j ACCEPT</span><br></pre></td></tr></table></figure>

<ul>
<li>修改规则</li>
</ul>
<p>命令语法：iptables -t 表名 -R 链名 规则序号 规则原本的匹配条件 -j 动作</p>
<p>示例：iptables -t filter -R INPUT 3 -s 192.168.1.146 -j ACCEPT</p>
<p>修改默认规则</p>
<p>命令语法：iptables -t 表名 -P 链名 动作</p>
<p>示例：iptables -t filter -P FORWARD ACCEPT</p>
<p>！！！ 修改iptables都是临时修改，iptables服务或者机器重启后都会丢失，一定要保存。</p>
<p>service iptables save</p>
<h2 id="匹配条件"><a href="#匹配条件" class="headerlink" title="匹配条件"></a>匹配条件</h2><p>匹配条件可以取反</p>
<p>基本匹配条件源ip 目的ip</p>
<p>扩展匹配条件 源端口， 目的端口，需要 -m参数指定模块</p>
<ul>
<li>扩展匹配模块</li>
</ul>
<p>tcp:匹配tcp协议 –sport –dport –tcp-flags –syn</p>
<p>multiport：匹配多个端口</p>
<p>iprange: 匹配连续IP范围</p>
<p>string: 匹配报文中包含的字符</p>
<p>time: 匹配报文的时间段区</p>
<p>connlimit：匹配单个ip连接数量</p>
<p>limit: 匹配单位时间内的报文数量</p>
<p>udp: 匹配udp协议</p>
<p>icmp: 匹配icmp协议</p>
<p>state: 匹配连接状态，实现连接追踪</p>
<h2 id="黑白名单机制"><a href="#黑白名单机制" class="headerlink" title="黑白名单机制"></a>黑白名单机制</h2><ul>
<li>黑名单机制</li>
</ul>
<p>INPUT链默认策略设置为ACCEPT，添加动作为DROP的规则。不够安全</p>
<ul>
<li>白名单机制</li>
</ul>
<p>1）链默认策略设置为RDROP，添加动作为ACCEPT的规则，但是规则清空后，管理员也无法登录主机。</p>
<p>2）链默认策略设置为ACCEPT，设置放行规则完毕之后，在最后设置一条拒绝所有连接的规则。</p>
<h2 id="自定义链"><a href="#自定义链" class="headerlink" title="自定义链"></a>自定义链</h2><p>方便管理各种规则，普通规则的动作设置为自定义链，符合条件的报文会经过自定义链的规则。</p>
<p>Docker一般也会添加自定义链。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加自定义链</span></span><br><span class="line">iptables -t filter -N IN_WEB</span><br><span class="line"><span class="comment"># 引用</span></span><br><span class="line">iptables -t filter -I INPUT -p tcp --dport 80 -j IN_WEB</span><br><span class="line"><span class="comment"># 修改名称</span></span><br><span class="line">iptables -E IN_WEB WEB</span><br><span class="line"><span class="comment"># 删除</span></span><br><span class="line">iptables -X WEB</span><br></pre></td></tr></table></figure>

<h2 id="动作总结"><a href="#动作总结" class="headerlink" title="动作总结"></a>动作总结</h2><ul>
<li>accept</li>
<li>drop</li>
<li>log</li>
<li>snat 用来隐藏内网IP或者共享公网IP。</li>
<li>dnat 用来暴露内网服务</li>
</ul>
<p>snat dnat 都用到了snat dnat两个动作，snat在前就叫snat, dnat在前就叫dnat</p>
<ul>
<li>masquerde 和snat相似，区别在于不绑定具体ip，而绑定网卡上的可用ip，用在外网ip地址常变动场景下。</li>
<li>redirect 本机端口映射</li>
</ul>
<h2 id="套路总结"><a href="#套路总结" class="headerlink" title="套路总结"></a>套路总结</h2><ul>
<li>规则顺序很重要，如果前面规则匹配，后面规则不会执行，所以相同服务的规则，更严格的规则要放前面</li>
<li>规则中多个匹配项存在“与“的关系</li>
<li>不考虑第一条规则的情况下，使用频率更高的规则放前面，节省主机计算资源。</li>
<li>iptables作为防火墙时，要考虑双向性，从内到外，从外到内。</li>
<li>设置白名单机制时，通常将链默认策略设置为ACCEPT，设置放行规则完毕之后，在最后设置一条拒绝所有连接的规则。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="site-author-image" itemprop="image" alt="胡挺"
    src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">胡挺</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">16</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">胡挺</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.0.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.4.2
  </div>

        












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  


















  

  

  

</body>
</html>
